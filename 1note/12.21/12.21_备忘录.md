这是一份为您总结的项目备忘录。这份文档梳理了从理论验证到工程落地的核心逻辑，您可以直接打印出来贴在实验室墙上，或作为后续代码开发的指导大纲。

---

# 📝 工程备忘录：髋关节外骨骼控制策略

**核心策略：带相位超前的稀疏前馈控制 (Phase-Lead Sparse Feedforward Control)**
**当前阶段：** 理论验证完成  进入算法落地阶段

---

### 1. 核心控制逻辑

我们放弃全周期跟随，采用**“掐头去尾，只抓重点”**的策略，专注于人体代谢收益最高的摆动相（Swing Phase）。

* **控制公式：**


* **关键定义：**
* `P_real` (当前真实相位)：基于传感器检测到的步态百分比 (0% - 100%)。
* `P_predict` (预测相位)：，用于补偿延迟。
* `f_assist` (助力曲线)：仅在特定窗口生效的力矩函数。



---

### 2. 关键参数设置 (Hard Coded Parameters)

| 参数名称 | 推荐设定值 | 物理/工程含义 |
| --- | --- | --- |
| **助力窗口 (Window)** | **60% ~ 90%** | 对应脚尖离地后的“提腿”阶段。避开着地期的危险反向力矩。 |
| **峰值力矩 (Peak Torque)** | **20.0 ~ 23.0 Nm** | 电机极限为 23.7 Nm。设定 23 Nm 为软限幅，确保不过热。 |
| **相位超前 (Phase Lead)** | **0.02 ~ 0.05 (2%-5%)** | 补偿通讯(1ms) + 机械传输 + 电机响应(10ms) 的总延迟。 |
| **曲线形态 (Profile)** | **正弦波半波 / 高斯波** | 不要用方波，必须平滑过渡。 对应窗口 60%~90%。 |
| **安全限位 (Soft Limit)** | **Max 1.58 / Min -0.24** | 弧度值 (基于 `limit_gait.csv` 实测)，触达即触发高阻尼保护。 |

---

### 3. 数据与硬件现状

* **硬件状态：**
* 电机：Unitree GO-M8010-6 (减速比 6.33)。
* 能力验证：零力矩模式实测阻力 ，透明度极佳。
* 能力瓶颈：峰值力矩 (23.7 Nm) 略小于理论最大需求 (29 Nm)，但满足 **80% 助力** 需求，完全可用。


* **数据来源：**
* 基于论文 (Bianco et al.) 提取的 `mrsmod_deviceHf_walk2_moments_Met.csv`。
* **处理决定：** 舍弃 0% 处的 0.7 Nm/kg 异常峰值（伸髋力矩），仅保留摆动相 0.42 Nm/kg 峰值（屈髋力矩）。



---

### 4. 代码实现逻辑 (伪代码)

```python
# 1. 常量定义
USER_WEIGHT = 70.0  # kg
PEAK_TORQUE_LIMIT = 23.0 # Nm
PHASE_LEAD = 0.03   # 提前 3%

def control_loop():
    while True:
        # A. 获取传感器数据，计算当前真实相位 (难点)
        current_real_phase = get_gait_phase_from_sensors() # 0.0 ~ 1.0

        # B. 施加相位超前 (预测未来)
        control_phase = current_real_phase + PHASE_LEAD
        if control_phase > 1.0: control_phase -= 1.0

        # C. 计算稀疏前馈力矩
        target_tau = 0.0
        
        # 仅在 60% - 90% 窗口内工作
        if 0.60 <= control_phase <= 0.90:
            # 归一化到 0~1 (用于查表或计算正弦)
            norm_x = (control_phase - 0.60) / (0.90 - 0.60)
            
            # 使用正弦波模拟论文中的凸起 (0 -> 1 -> 0)
            # 0.42 是论文中的峰值系数 (Nm/kg)
            peak_value = 0.42 * USER_WEIGHT 
            
            # 安全截断
            if peak_value > PEAK_TORQUE_LIMIT: peak_value = PEAK_TORQUE_LIMIT
            
            target_tau = peak_value * math.sin(norm_x * math.pi)

        # D. 发送指令 (带微弱阻尼防飞车)
        cmd.tau = target_tau
        cmd.kp = 0.0
        cmd.kd = 1.0  # 基础安全阻尼
        serial.sendRecv(cmd, data)

```

---

### 5. 下一步行动 (Action Items)

1. **[优先] 相位估计算法开发：**
* 这是目前唯一的未知数。需要利用现有的 IMU/角度/压力数据，准确判断出 **0% (着地)** 和 **60% (离地)** 这两个关键时间点。


2. **[安全] 软限位测试：**
* 在代码中加入 `if q > 1.58: kp=40` 的逻辑，并手动推拉腿部验证是否能触发反弹保护。


3. **[体验] 静态触发测试：**
* 先把外骨骼架空，手动输入模拟的 `phase` 信号，观察电机是否在 60%-90% 区间平滑地“动一下”。


4. **[上身] 穿戴测试：**
* 先设置较小的峰值 (如 5 Nm)，感受相位是否对齐（是否在想提腿的时候刚好推你）。如果感觉“顶腿”或“拖拽”，调整 `PHASE_LEAD` 参数。



---

**一句话总结：**
我们不追求完美的生物力学复现，而是利用电机的特性，做一个**“只在提腿时帮一把”**的聪明外骨骼。这是一个工程上极其稳健的方案。