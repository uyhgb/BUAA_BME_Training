# å¤–éª¨éª¼æ§åˆ¶ç³»ç»Ÿé›†æˆæ–‡æ¡£

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¤–éª¨éª¼æ§åˆ¶ç³»ç»Ÿ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼ æ„Ÿå™¨å±‚:
â”œâ”€â”€ IMUä¼ æ„Ÿå™¨ (ESP32)      -> /dev/imu_usb
â””â”€â”€ è¶³åº•å‹åŠ›ä¼ æ„Ÿå™¨ (CH340) -> /dev/foot_usb

ROS2èŠ‚ç‚¹:
â”œâ”€â”€ imu_csv_reader        (exo_sensors)        è¯»å–IMU -> /imu/data
â”œâ”€â”€ foot_state_machine    (exo_sensors)        è¯»å–è¶³åº• -> /foot/gait_state
â”œâ”€â”€ gait_inference_node   (exoskel_control_py) IMU -> SVM -> /control/cmd_torque
â””â”€â”€ motor_driver_node     (exoskel_control_py) åŠ›çŸ© -> Unitreeç”µæœº

æ‰§è¡Œå™¨å±‚:
â””â”€â”€ å®‡æ ‘ç”µæœº (GO-M8010-6)  -> /dev/unitree_motor
```

## å·²å®Œæˆçš„å·¥ä½œ

### âœ… 1. åŠŸèƒ½åŒ…æ³¨å†Œ
- [x] exoskel_control_py å®Œæ•´æ³¨å†Œ
  - package.xml
  - setup.py  
  - setup.cfg
  - resourceæ–‡ä»¶
  
- [x] robot_controller å·²æ³¨å†Œ (C++åŒ…)
  - CMakeLists.txt å·²é…ç½®
  - main_controller èŠ‚ç‚¹å·²ç¼–è¯‘

### âœ… 2. æ ¸å¿ƒèŠ‚ç‚¹å®Œå–„

#### 2.1 main_controller.cpp (C++)
**åŠŸèƒ½**: IMUç¡¬ä»¶æ•°æ®è¯»å– -> å‘å¸ƒ `/imu/data`

**çŠ¶æ€**: âœ… å·²æ³¨å†Œï¼Œå·²ç¼–è¯‘ï¼ŒåŠŸèƒ½å®Œæ•´

**å…³é”®åŠŸèƒ½**:
- è®¢é˜… `/imu/data` (sensor_msgs/Imu)
- å››å…ƒæ•° -> æ¬§æ‹‰è§’è½¬æ¢
- 50Hz æ§åˆ¶å¾ªç¯
- ç›‘æ§æ¨¡å¼ (enable_control:=false)

**å¯åŠ¨æ–¹å¼**:
```bash
ros2 run robot_controller main_controller
```

#### 2.2 gait_inference_node.py
**åŠŸèƒ½**: IMUæ•°æ® -> ç‰¹å¾æå– -> SVMé¢„æµ‹ -> åŠ›çŸ©è®¡ç®—

**çŠ¶æ€**: âœ… å·²å®Œå–„ï¼Œå·²æ³¨å†Œ

**å…³é”®æ”¹è¿›**:
- ä¿®æ­£ rclpy å¯¼å…¥
- å®Œå–„å››å…ƒæ•°è½¬æ¬§æ‹‰è§’
- ä½¿ç”¨ ament_index åŠ è½½æ¨¡å‹
- å‚æ•°åŒ–é…ç½®

**å¯åŠ¨æ–¹å¼**:
```bash
ros2 run exoskel_control_py gait_inference_node
```

#### 2.3 motor_driver_node.py
**åŠŸèƒ½**: è®¢é˜…åŠ›çŸ©æŒ‡ä»¤ -> Unitree SDK -> é©±åŠ¨ç”µæœº

**çŠ¶æ€**: âœ… å·²å®Œå–„ï¼Œå·²æ³¨å†Œ

**å…³é”®æ”¹è¿›**:
- ä¿®æ­£ rclpy å¯¼å…¥
- å‚æ•°åŒ–é…ç½®
- SDKç¼ºå¤±æ—¶è‡ªåŠ¨è¿›å…¥æ¨¡æ‹Ÿæ¨¡å¼
- å®‰å…¨é™å¹…å’Œé€€å‡ºåˆ¹è½¦

**å¯åŠ¨æ–¹å¼**:
```bash
ros2 run exoskel_control_py motor_driver_node
```

### âœ… 3. é…ç½®æ–‡ä»¶
- `config/gait_inference.yaml` - SVMæ¨ç†å‚æ•°
- `config/motor_driver.yaml` - ç”µæœºé©±åŠ¨å‚æ•°

### âœ… 4. Launchæ–‡ä»¶
- `launch/exoskel_control.launch.py` - å®Œæ•´ç³»ç»Ÿå¯åŠ¨

---

## ç³»ç»Ÿå¯åŠ¨æŒ‡å—

### æ–¹å¼1: åˆ†æ­¥å¯åŠ¨ (è°ƒè¯•æ¨è)

#### ç»ˆç«¯1: IMUæ•°æ®é‡‡é›†
```bash
cd /workspace/robot_ws
source /opt/ros/humble/setup.bash
source install/setup.bash
ros2 launch exo_sensors imu_csv_raspberry_pi.launch.py
```

#### ç»ˆç«¯2: æ­¥æ€æ¨ç†
```bash
cd /workspace/robot_ws
source install/setup.bash
ros2 run exoskel_control_py gait_inference_node
```

#### ç»ˆç«¯3: ç”µæœºé©±åŠ¨ (å¯é€‰)
```bash
cd /workspace/robot_ws
source install/setup.bash
ros2 run exoskel_control_py motor_driver_node
```

### æ–¹å¼2: ä¸€é”®å¯åŠ¨ (ç”Ÿäº§ç¯å¢ƒ)

```bash
cd /workspace/robot_ws
source /opt/ros/humble/setup.bash
source install/setup.bash

# ä¸å¯ç”¨ç”µæœº (ä»…æµ‹è¯•SVM)
ros2 launch exoskel_control_py exoskel_control.launch.py enable_motor:=false

# å¯ç”¨ç”µæœº (å®é™…åŠ©åŠ›)
ros2 launch exoskel_control_py exoskel_control.launch.py enable_motor:=true
```

---

## æ•°æ®æµæ£€æŸ¥

### æ£€æŸ¥IMUæ•°æ®
```bash
ros2 topic echo /imu/data --once
ros2 topic hz /imu/data  # åº”æ˜¾ç¤º ~100Hz
```

### æ£€æŸ¥åŠ›çŸ©æŒ‡ä»¤
```bash
ros2 topic echo /control/cmd_torque
```

### æŸ¥çœ‹æ‰€æœ‰è¯é¢˜
```bash
ros2 topic list
# åº”çœ‹åˆ°:
# /imu/data
# /control/cmd_torque
# /foot/gait_state (å¦‚æœå¯åŠ¨äº†è¶³åº•ä¼ æ„Ÿå™¨)
```

---

## è¶³åº•ä¼ æ„Ÿå™¨æ•´åˆæ–¹æ¡ˆ

### ğŸ¯ æ•´åˆç›®æ ‡
å°†è¶³åº•ä¼ æ„Ÿå™¨çš„æ­¥æ€çŠ¶æ€ (`/foot/gait_state`) ç”¨äº:
1. **è§¦å‘åŠ©åŠ›æ—¶æœº**: åªåœ¨ç«™ç«‹æœŸ (stance) æä¾›åŠ©åŠ›
2. **å®‰å…¨ä¿æŠ¤**: æ‘†åŠ¨æœŸ (swing) å¼ºåˆ¶åŠ›çŸ©ä¸º0
3. **æ­¥æ€åŒæ­¥**: ç»“åˆIMUç›¸ä½å’Œè¶³åº•çŠ¶æ€

### ğŸ“ æ–¹æ¡ˆä¸€: ç®€å•è§¦å‘ (æ¨èå…ˆå®ç°)

ä¿®æ”¹ `gait_inference_node.py`ï¼Œæ·»åŠ è¶³åº•çŠ¶æ€è®¢é˜…ï¼š

```python
# åœ¨ __init__ ä¸­æ·»åŠ 
self.foot_state = "swing"  # åˆå§‹ä¸ºæ‘†åŠ¨æœŸ
self.sub_foot = self.create_subscription(
    String,
    '/foot/gait_state',
    self.foot_callback,
    10
)

# æ·»åŠ å›è°ƒå‡½æ•°
def foot_callback(self, msg):
    self.foot_state = msg.data  # "stance" æˆ– "swing"

# ä¿®æ”¹ imu_callback ä¸­çš„åŠ›çŸ©å‘å¸ƒé€»è¾‘
def imu_callback(self, msg):
    # ... ç°æœ‰ä»£ç  ...
    
    # è®¡ç®—ç¨€ç–åŠ©åŠ›
    target_tau = self.gaussian_assist(phase)
    
    # ã€æ–°å¢ã€‘è¶³åº•çŠ¶æ€å®‰å…¨æ£€æŸ¥
    if self.foot_state != "stance":
        target_tau = 0.0  # æ‘†åŠ¨æœŸå¼ºåˆ¶ä¸º0
    
    # å‘å¸ƒå‘½ä»¤
    out_msg = Float32()
    out_msg.data = float(target_tau)
    self.pub_torque.publish(out_msg)
```

### ğŸ“ æ–¹æ¡ˆäºŒ: æ­¥æ€åŒæ­¥ (é«˜çº§)

ç»“åˆè¶³åº•å’ŒIMUçš„æ­¥æ€å‘¨æœŸä¿¡æ¯ï¼š

```python
def imu_callback(self, msg):
    # ... ç‰¹å¾æå– ...
    phase = self.model.predict(features)[0]
    
    # ã€æ–°å¢ã€‘æ­¥æ€å‘¨æœŸåŒæ­¥é€»è¾‘
    if self.foot_state == "swing":
        # æ‘†åŠ¨æœŸ: ç›¸ä½åº”è¯¥åœ¨ 0.7-1.0 æˆ– 0.0-0.3
        # å¦‚æœSVMé¢„æµ‹çš„ç›¸ä½ä¸åˆç†ï¼Œå¯ä»¥æ ¡æ­£
        if 0.4 < phase < 0.7:
            phase = 0.0  # é‡ç½®ç›¸ä½
    
    target_tau = self.gaussian_assist(phase)
    
    # æ‘†åŠ¨æœŸä¿æŠ¤
    if self.foot_state != "stance":
        target_tau = 0.0
```

### ğŸš€ å¯åŠ¨å®Œæ•´ç³»ç»Ÿ (å«è¶³åº•ä¼ æ„Ÿå™¨)

#### ç»ˆç«¯1: ä¼ æ„Ÿå™¨é‡‡é›†
```bash
# å¯åŠ¨IMU
ros2 launch exo_sensors imu_csv_raspberry_pi.launch.py &

# å¯åŠ¨è¶³åº•ä¼ æ„Ÿå™¨
ros2 launch exo_sensors foot_state_machine.launch.py &
```

#### ç»ˆç«¯2: æ§åˆ¶ç³»ç»Ÿ
```bash
ros2 launch exoskel_control_py exoskel_control.launch.py enable_motor:=false
```

### ğŸ” éªŒè¯æ•´åˆæ•ˆæœ

```bash
# æŸ¥çœ‹è¶³åº•çŠ¶æ€
ros2 topic echo /foot/gait_state

# åŒæ—¶æŸ¥çœ‹åŠ›çŸ©æŒ‡ä»¤
ros2 topic echo /control/cmd_torque

# éªŒè¯é€»è¾‘: 
# - stance (ç«™ç«‹æœŸ) -> åŠ›çŸ©éé›¶
# - swing (æ‘†åŠ¨æœŸ)  -> åŠ›çŸ©ä¸ºé›¶
```

---

## ä¸‹ä¸€æ­¥å·¥ä½œå»ºè®®

### çŸ­æœŸ (1-2å¤©)
1. [ ] é‡‡é›†è®­ç»ƒæ•°æ® (ä¸åŒæ­¥æ€æ¨¡å¼)
2. [ ] è®­ç»ƒSVMæ¨¡å‹
3. [ ] å°†æ¨¡å‹æ–‡ä»¶æ”¾å…¥ `config/` ç›®å½•
4. [ ] æµ‹è¯•æ­¥æ€æ¨ç†ç²¾åº¦

### ä¸­æœŸ (1å‘¨)
1. [ ] æ•´åˆè¶³åº•ä¼ æ„Ÿå™¨ (æ–¹æ¡ˆä¸€)
2. [ ] è°ƒæ•´åŠ©åŠ›å‚æ•° (æ—¶æœºã€å¹…åº¦)
3. [ ] æ ‘è“æ´¾ä¸Šå®é™…æµ‹è¯•
4. [ ] æ·»åŠ æ•°æ®è®°å½•åŠŸèƒ½

### é•¿æœŸ (2å‘¨+)
1. [ ] å®ç°æ­¥æ€åŒæ­¥ (æ–¹æ¡ˆäºŒ)
2. [ ] å¤šä¼ æ„Ÿå™¨èåˆ
3. [ ] è‡ªé€‚åº”å‚æ•°è°ƒæ•´
4. [ ] å®‰å…¨ä¿æŠ¤å®Œå–„

---

## å¸¸è§é—®é¢˜

### Q1: æ¨¡å‹æ–‡ä»¶æ”¾å“ªé‡Œ?
**A**: æ”¾åœ¨ `/workspace/robot_ws/src/exoskel_control_py/config/` ç›®å½•
- `optimized_gait_svm_model.pkl` - SVMæ¨¡å‹
- `optimized_gait_scaler.pkl` - æ ‡å‡†åŒ–å™¨

### Q2: å¦‚ä½•è°ƒæ•´åŠ©åŠ›æ—¶æœº?
**A**: ä¿®æ”¹ `config/gait_inference.yaml`:
```yaml
assist_peak_phase: 0.60  # 60%ç›¸ä½åŠ©åŠ›ï¼ˆå¯è°ƒæ•´ï¼‰
phase_lead: 0.05         # æå‰5%ç›¸ä½
assist_width: 0.10       # çª—å£å®½åº¦10%
```

### Q3: ç”µæœºä¸åŠ¨æ€ä¹ˆåŠ?
**A**: æ£€æŸ¥æ­¥éª¤:
1. ç¡®è®¤ `enable_motor:=true`
2. æŸ¥çœ‹ `/control/cmd_torque` æ˜¯å¦æœ‰éé›¶å€¼
3. æ£€æŸ¥ Unitree SDK æ˜¯å¦æ­£ç¡®å®‰è£…
4. æŸ¥çœ‹ motor_driver_node æ—¥å¿—

### Q4: å¦‚ä½•è®°å½•æ•°æ®?
**A**: ä½¿ç”¨ rosbag:
```bash
ros2 bag record /imu/data /foot/gait_state /control/cmd_torque
```

---

## æ–‡ä»¶æ¸…å•

### exoskel_control_py åŠŸèƒ½åŒ…
```
exoskel_control_py/
â”œâ”€â”€ package.xml                          âœ… å·²åˆ›å»º
â”œâ”€â”€ setup.py                             âœ… å·²åˆ›å»º
â”œâ”€â”€ setup.cfg                            âœ… å·²åˆ›å»º
â”œâ”€â”€ resource/exoskel_control_py          âœ… å·²åˆ›å»º
â”œâ”€â”€ exoskel_control_py/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ gait_inference_node.py           âœ… å·²å®Œå–„
â”‚   â””â”€â”€ motor_driver_node.py             âœ… å·²å®Œå–„
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ gait_inference.yaml              âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ motor_driver.yaml                âœ… å·²åˆ›å»º
â”‚   â”œâ”€â”€ optimized_gait_svm_model.pkl     â³ å¾…è®­ç»ƒ
â”‚   â””â”€â”€ optimized_gait_scaler.pkl        â³ å¾…è®­ç»ƒ
â””â”€â”€ launch/
    â””â”€â”€ exoskel_control.launch.py        âœ… å·²åˆ›å»º
```

### robot_controller åŠŸèƒ½åŒ…
```
robot_controller/
â”œâ”€â”€ CMakeLists.txt                       âœ… å·²æ³¨å†Œ
â”œâ”€â”€ package.xml                          âœ… å·²æ³¨å†Œ
â””â”€â”€ src/
    â””â”€â”€ main_controller.cpp              âœ… å·²å®Œå–„
```

---

**çŠ¶æ€**: âœ… æ‰€æœ‰åŠŸèƒ½åŒ…å·²æ³¨å†Œï¼Œæ ¸å¿ƒä»£ç å·²å®Œå–„ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•å’Œæ•´åˆï¼
